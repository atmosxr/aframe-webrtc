!function(e){function t(o){if(n[o])return n[o].exports;var i=n[o]={exports:{},id:o,loaded:!1};return e[o].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){if("undefined"==typeof AFRAME)throw new Error("Component attempted to register beforeAFRAME was available.");var o=n(1);AFRAME.registerComponent("webrtc",{schema:{room:{type:"int",default:5555},ws:{type:"string",default:"wss://boiling-anchorage-5279.herokuapp.com/"}},init:function(){this.master=!1,this.connected=!1,this.senders=[],this.receivers=[];var e=this.data;this.peer=new o(e.room,e.ws,this),this.peer.createPeerConnection()},update:function(){},remove:function(){},tick:function(e,t){},notifyWsReady:function(e){console.log("Web Socket is Ready"),console.log(e)},notifyRoomUpdate:function(e){console.log("Room Updated"),console.log(e+" people in the room"),1===e?(this.master=!0,console.log("You became a master")):2===e?this.master&&this.peer.offer():e>2&&console.log("Over the capacity")},notifyOpenPeer:function(e){console.log("Peer Opened"),console.log(e),this.connected=!0,this.sendConnection("a-entity"),this.sendConnection("a-camera")},sendConnection:function(e){for(var t=this.el.querySelectorAll(e),n=0,o=t.length;n<o;n++){var i=t[n];i.getAttribute("webrtc-sender")&&(this.senders.push(i),i.emit("connected",{peer:this.peer})),i.getAttribute("webrtc-receiver")&&(this.receivers.push(i),i.emit("connected",{peer:this.peer}))}},receiveFromPeer:function(e){for(var t=0,n=this.receivers.length;t<n;t++)this.receivers[t].emit("received",{data:e})}}),AFRAME.registerComponent("webrtc-sender",{schema:{},init:function(){this.peer=null;var e=this;this.el.addEventListener("connected",function(t){e.connected(t)})},update:function(){},remove:function(){},tick:function(e,t){if(null!==this.peer&&this.el.object3D){var n=this.el.object3D;this.peer.send({position:n.position.toArray(),quaternion:n.quaternion.toArray()})}},connected:function(e){this.peer=e.detail.peer}}),AFRAME.registerComponent("webrtc-receiver",{schema:{},init:function(){this.peer=null;var e=this;this.el.addEventListener("connected",function(t){e.connected(t)}),this.el.addEventListener("received",function(t){e.received(t)})},update:function(){},remove:function(){},tick:function(e,t){},connected:function(e){this.peer=e.detail.peer},received:function(e){if(null!==this.peer&&this.el.object3D){var t=e.detail.data.position,n=e.detail.data.quaternion,o=this.el.object3D;o.position.fromArray(t),o.position.y-=1.5,o.quaternion.fromArray(n),o.rotateY(Math.PI)}}})},function(e,t){function n(e,t,n){this.room=e,this.peopleInTheRoom=0,this.ws=new WebSocket(t),this.receiver=n,this.pc=null,this.channel=null;var o=this;this.gotSDPFunc=function(e){o._gotSDP(e)},this.onIceCandidateFunc=function(e){o._onIceCandidate(e)},this.onDataChannelFunc=function(e){o._onDataChannel(e)},this.onMessageFunc=function(e){o._onMessage(e)},this.onOpenFunc=function(e){o._onOpen(e)},this.onCloseFunc=function(e){o._onClose(e)},this.onErrorFunc=function(e){o._onError(e)},this.dummySendFunc=function(){o._keepSendDummy()},this.ws.onmessage=function(e){o._gotSignal(e)},this.ws.onopen=function(e){o._wsReady(e)},this.interval=null,this.peerConnected=!1}n.prototype._PEER_ID_DUMMY=-1,n.prototype._PEER_ID_NOTICE_ROOM=0,n.prototype._PEER_ID_SYNC=1,n.prototype._ICE_SERVERS=[{url:"stun:stun01.sipphone.com"},{url:"stun:stun.ekiga.net"},{url:"stun:stun.fwdnet.net"},{url:"stun:stun.ideasip.com"},{url:"stun:stun.iptel.org"},{url:"stun:stun.rixtelecom.se"},{url:"stun:stun.schlund.de"},{url:"stun:stun.l.google.com:19302"},{url:"stun:stun1.l.google.com:19302"},{url:"stun:stun2.l.google.com:19302"},{url:"stun:stun3.l.google.com:19302"},{url:"stun:stun4.l.google.com:19302"},{url:"stun:stunserver.org"},{url:"stun:stun.softjoys.com"},{url:"stun:stun.voiparound.com"},{url:"stun:stun.voipbuster.com"},{url:"stun:stun.voipstunt.com"},{url:"stun:stun.voxgratia.org"},{url:"stun:stun.xten.com"},{url:"turn:numb.viagenie.ca",credential:"muazkh",username:"webrtc@live.com"},{url:"turn:192.158.29.39:3478?transport=udp",credential:"JZEOEt2V3Qb0y27GRntt2u2PAYA=",username:"28224511:1379330808"},{url:"turn:192.158.29.39:3478?transport=tcp",credential:"JZEOEt2V3Qb0y27GRntt2u2PAYA=",username:"28224511:1379330808"}],n.prototype._DUMMY_SPAN=2e4,n.prototype._DUMMY_DATA=JSON.stringify({_pid:n.prototype._PEER_ID_DUMMY}),n.prototype.log=function(e){},n.prototype._wsReady=function(e){void 0!==this.receiver.notifyWsReady&&this.receiver.notifyWsReady(e),this._noticeRoom(),this._keepSendDummy()},n.prototype._noticeRoom=function(){var e=JSON.stringify({_pid:this._PEER_ID_NOTICE_ROOM,room:this.room});this.ws.send(e)},n.prototype.sendSignal=function(e){var t=JSON.stringify(e);this.ws.send(t),this.log(t)},n.prototype._gotSignal=function(e){var t=JSON.parse(e.data);if(void 0===t._pid)switch(t.type){case"offer":this._gotOffer(t);break;case"answer":this._gotAnswer(t);break;case"candidate":this._gotCandidate(t)}else t._pid==n.prototype._PEER_ID_NOTICE_ROOM&&(this.peopleInTheRoom=t.num,void 0!==this.receiver.notifyRoomUpdate&&this.receiver.notifyRoomUpdate(this.peopleInTheRoom));this.log(t)},n.prototype.createPeerConnection=function(){var e={iceServers:this._ICE_SERVERS};this.pc=new webkitRTCPeerConnection(e),this.pc.onicecandidate=this.onIceCandidateFunc},n.prototype._onIceCandidate=function(e){if(e.candidate){var t={type:"candidate",sdpMLineIndex:e.candidate.sdpMLineIndex,candidate:e.candidate.candidate};this.sendSignal(t)}},n.prototype.offer=function(){this.channel=this.pc.createDataChannel("mychannel",{reliable:!1}),this.channel.onmessage=this.onMessageFunc,this.channel.onopen=this.onOpenFunc,this.channel.onclose=this.onCloseFunc,this.channel.onerror=function(e){window.alert(e),console.log(e)},this.pc.createOffer(this.gotSDPFunc,this.onErrorFunc)},n.prototype._gotSDP=function(e){this.pc.setLocalDescription(e),this.sendSignal(e)},n.prototype._gotOffer=function(e){this.pc.ondatachannel=this.onDataChannelFunc,this._setRemoteDescription(e),this.pc.createAnswer(this.gotSDPFunc,this.onErrorFunc)},n.prototype._gotAnswer=function(e){this._setRemoteDescription(e)},n.prototype._gotCandidate=function(e){var t=new RTCIceCandidate(e);this.pc.addIceCandidate(t)},n.prototype._setRemoteDescription=function(e){this.pc.setRemoteDescription(new RTCSessionDescription(e))},n.prototype._onDataChannel=function(e){this.channel=e.channel,this.channel.onmessage=this.onMessageFunc,this.channel.onopen=this.onOpenFunc,this.channel.onclose=this.onCloseFunc},n.prototype._onOpen=function(e){this.peerConnected=!0,this.ws.close(1e3),void 0!==this.receiver.notifyOpenPeer&&this.receiver.notifyOpenPeer(e)},n.prototype._onClose=function(e){this.peerConnected=!1,void 0!==this.receiver.notifyClosePeer&&this.receiver.notifyClosePeer(e)},n.prototype._onError=function(e){window.alert(e)},n.prototype._onMessage=function(e){this.log(e.data),this.receiver.receiveFromPeer(JSON.parse(e.data))},n.prototype.send=function(e){this.channel.send(JSON.stringify(e))},n.prototype._keepSendDummy=function(){this.ws.send(this._DUMMY_DATA),this._setIntervalForDummy()},n.prototype._setIntervalForDummy=function(){this.ws&&!this.peerConnected&&(this.interval=setTimeout(this.dummySendFunc,this._DUMMY_SPAN))},e.exports=n}]);